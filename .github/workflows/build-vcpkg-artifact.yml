name: ONE-TIME VCPKG ARTIFACT BUILD

on:
  workflow_dispatch: {}

jobs:
  build-artifact:
    name: "Build Vcpkg Artifact for ARM64"
    runs-on: windows-11-arm
    timeout-minutes: 360

    steps:
      - uses: actions/checkout@v4
      - name: Install Vulkan SDK
        shell: pwsh
        run: |
          $vulkan_sdk_version = "1.3.290.0"
          $vulkan_sdk_url = "https://sdk.lunarg.com/sdk/download/$vulkan_sdk_version/warm/InstallVulkanARM64-$vulkan_sdk_version.exe"
          Invoke-WebRequest -Uri $vulkan_sdk_url -OutFile VulkanSDK-Installer.exe
          Start-Process -FilePath ".\VulkanSDK-Installer.exe" -ArgumentList "--accept-licenses", "--default-answer", "--confirm-command", "install" -Wait
          echo "VULKAN_SDK=C:\VulkanSDK\$vulkan_sdk_version" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Clone Citron Source
        run: git clone --recursive "https://git.citron-emu.org/Citron/Emulator.git" citron

      - name: Configure vcpkg.json with all required dependencies
        working-directory: ./citron
        shell: pwsh
        run: |
          Write-Host "Forcing ARM64 build to use vcpkg for ALL dependencies..."
          $vcpkgJsonPath = "vcpkg.json"
          $json = Get-Content $vcpkgJsonPath -Raw | ConvertFrom-Json
          $json.dependencies += "qtbase"
          $json.dependencies += "qtmultimedia"
          $json.dependencies += "openssl"
          $json.dependencies += "libarchive"
          $json.dependencies += "ffmpeg"
          $json.dependencies += "sdl2"
          $json.dependencies += "hidapi"
          $json.dependencies += "getopt"
          $json | ConvertTo-Json -Depth 10 | Set-Content $vcpkgJsonPath
          Write-Host "SUCCESS: Correctly patched vcpkg.json to build all required dependencies."

      - name: Build All Dependencies with Patches
        working-directory: ./citron
        shell: bash
        env:
          VCPKG_DEFAULT_HOST_TRIPLET: custom-arm64-windows
        run: |
          # Bootstrap vcpkg
          ./externals/vcpkg/bootstrap-vcpkg.bat
          
          # Create the custom triplet file to pass the VULKAN_SDK environment variable
          cp ./externals/vcpkg/triplets/arm64-windows.cmake ./externals/vcpkg/triplets/custom-arm64-windows.cmake
          echo 'set(VCPKG_ENV_PASSTHROUGH "VULKAN_SDK")' >> ./externals/vcpkg/triplets/custom-arm64-windows.cmake

          echo "Creating custom vcpkg port for Vulkan-Utility-Libraries to fix CMake generation..."
          
          # 1. Create a directory for our custom vcpkg port
          mkdir -p ./my-vcpkg-ports/vulkan-utility-libraries

          # 2. Create the patch file that removes the faulty "if (VUL_IS_TOP_LEVEL)" check
          cat << 'EOF' > ./my-vcpkg-ports/vulkan-utility-libraries/fix-toplevel-check.patch
          --- a/CMakeLists.txt
          +++ b/CMakeLists.txt
          @@ -25,10 +25,7 @@
           add_subdirectory(src)
           add_subdirectory(include)
           
          -if (VUL_IS_TOP_LEVEL)
          -    option(BUILD_TESTS "Build tests")
          -    if (BUILD_TESTS)
          +if (BUILD_TESTS)
                   enable_testing()
                   add_subdirectory(tests)
               endif()
          @@ -73,4 +70,3 @@
           install(FILES ${CMAKE_CURRENT_BINARY_DIR}/VulkanUtilityLibrariesConfig.cmake
               DESTINATION ${CMAKE_INSTALL_LIBDIR}/cmake/VulkanUtilityLibraries
           )
          -endif()
          EOF

          # 3. Create the portfile.cmake that tells vcpkg to find the library and apply our patch
          cat << 'EOF' > ./my-vcpkg-ports/vulkan-utility-libraries/portfile.cmake
          vcpkg_from_github(
              OUT_SOURCE_PATH SOURCE_PATH
              REPO KhronosGroup/Vulkan-Utility-Libraries
              REF v1.3.290
              SHA512 8c886e3f56e9c0c16b6771d9d43516ac3864a7536d525f0282479e0a05a065a0439fe75f4d1e2e920d36b85642d99d14a51e592ca07e86888c3fd45a19003504
              HEAD_REF main
              PATCHES
                  fix-toplevel-check.patch
          )
          vcpkg_cmake_configure(
              SOURCE_PATH "\${SOURCE_PATH}"
              OPTIONS
                  -DBUILD_TESTS=OFF
          )
          vcpkg_cmake_install()
          vcpkg_cmake_config_fixup(PACKAGE_NAME "VulkanUtilityLibraries")
          file(REMOVE_RECURSE "\${CURRENT_PACKAGES_DIR}/debug/include")
          file(REMOVE_RECURSE "\${CURRENT_PACKAGES_DIR}/debug/share")
          vcpkg_install_copyright(FILE_LIST "\${SOURCE_PATH}/LICENSE.txt")
          EOF

          # 4. Run the install command, telling vcpkg to use our patched version
          echo "Running vcpkg install with the overlay port..."
          ./externals/vcpkg/vcpkg install --triplet=custom-arm64-windows --overlay-ports=./my-vcpkg-ports

      - name: Package the Artifact
        shell: pwsh
        run: |
          Compress-Archive -Path ".\citron\vcpkg_installed" -DestinationPath "vcpkg_installed_arm64.zip"

      - name: Upload the Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Vcpkg-ARM-64-Artifact
          path: "vcpkg_installed_arm64.zip"
